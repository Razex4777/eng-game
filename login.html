<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ - English Mastery Battle</title>
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-H90E46NFQT"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-H90E46NFQT');
    </script>
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            padding: 40px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo h1 {
            font-size: 28px;
            color: #1a1a2e;
            margin-bottom: 8px;
        }

        .logo p {
            color: #666;
            font-size: 14px;
        }

        /* Steps Indicator */
        .steps-indicator {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 30px;
        }

        .step-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ddd;
            transition: all 0.3s ease;
        }

        .step-dot.active {
            background: #4CAF50;
            transform: scale(1.2);
        }

        .step-dot.completed {
            background: #4CAF50;
        }

        /* Form Steps */
        .step {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .step.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .step-title {
            font-size: 20px;
            color: #333;
            margin-bottom: 8px;
            text-align: center;
        }

        .step-subtitle {
            color: #666;
            font-size: 14px;
            text-align: center;
            margin-bottom: 24px;
        }

        /* Google Button */
        .btn-google {
            width: 100%;
            padding: 14px 24px;
            border: 2px solid #ddd;
            border-radius: 12px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-size: 16px;
            font-weight: 600;
            color: #333;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-google:hover {
            border-color: #4285F4;
            background: #f8f9fa;
        }

        .btn-google:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .btn-google svg {
            width: 24px;
            height: 24px;
        }

        /* Input Fields */
        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .input-wrapper {
            position: relative;
        }

        .input-wrapper input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #ddd;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            text-align: right;
        }

        .input-wrapper input:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 4px rgba(76, 175, 80, 0.1);
        }

        .input-prefix {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            font-weight: 600;
        }

        .input-wrapper input.with-prefix {
            padding-left: 50px;
            text-align: left;
            direction: ltr;
        }

        .input-hint {
            font-size: 12px;
            color: #888;
            margin-top: 6px;
        }

        /* Buttons */
        .btn-primary {
            width: 100%;
            padding: 14px 24px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        /* Error Message */
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 16px;
            display: none;
        }

        .error-message.show {
            display: block;
            animation: shake 0.3s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Guest Link */
        .guest-link {
            text-align: center;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid #eee;
        }

        .guest-link a {
            color: #666;
            text-decoration: none;
            font-size: 14px;
            transition: color 0.3s ease;
        }

        .guest-link a:hover {
            color: #4CAF50;
        }

        /* Success Animation */
        .success-icon {
            width: 80px;
            height: 80px;
            background: #4CAF50;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            animation: scaleIn 0.3s ease;
        }

        .success-icon svg {
            width: 40px;
            height: 40px;
            fill: white;
        }

        @keyframes scaleIn {
            from { transform: scale(0); }
            to { transform: scale(1); }
        }

        /* Loading Spinner */
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid #ddd;
            border-top-color: #4CAF50;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Contact Info */
        .contact-info {
            background: #f5f5f5;
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
        }

        .contact-info a {
            color: #25D366;
            text-decoration: none;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        /* Back Button */
        .btn-back {
            background: transparent;
            border: none;
            color: #666;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: color 0.3s;
            width: fit-content;
        }
        
        .btn-back:hover {
            color: #333;
            transform: translateX(4px);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <h1>ğŸ® English Mastery</h1>
            <p>ØªØ¹Ù„Ù… Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ø¨Ø·Ø±ÙŠÙ‚Ø© Ù…Ù…ØªØ¹Ø©</p>
        </div>

        <!-- Steps Indicator -->
        <div class="steps-indicator">
            <div class="step-dot active" id="dot-1"></div>
            <div class="step-dot" id="dot-2"></div>
            <div class="step-dot" id="dot-3"></div>
            <div class="step-dot" id="dot-4"></div>
        </div>

        <!-- Step 1: Google Sign In -->
        <div class="step active" id="step-1">
            <h2 class="step-title">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ! ğŸ‘‹</h2>
            <p class="step-subtitle">Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ù„Ù„Ø¨Ø¯Ø¡ Ø¨Ø§Ù„Ù„Ø¹Ø¨ ÙˆØ­ÙØ¸ ØªÙ‚Ø¯Ù…Ùƒ</p>
            
            <div class="error-message" id="error-step1"></div>
            
            <button class="btn-google" id="btn-google" onclick="handleGoogleSignIn()">
                <svg viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø­Ø³Ø§Ø¨ Google
            </button>

            <div class="guest-link">
                <a href="index/index.html?guest=true">Ø£Ùˆ Ø¬Ø±Ø¨ Ø§Ù„Ù„Ø¹Ø¨Ø© ÙƒØ¶ÙŠÙ (Ù…Ø±Ø­Ù„Ø© Demo ÙÙ‚Ø·)</a>
            </div>
            
            <div style="text-align: center; margin-top: 16px;">
                <a href="https://wa.me/9647767275649" target="_blank" style="display: inline-flex; align-items: center; gap: 8px; color: #25D366; text-decoration: none; font-size: 14px; font-weight: 600; padding: 10px 20px; background: #e8f5e9; border-radius: 12px; transition: all 0.3s;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="#25D366"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                    ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨
                </a>
            </div>
        </div>

        <!-- Step 2: Phone Number -->
        <div class="step" id="step-2">
            <button class="btn-back" onclick="showStep(1)">â† Ø±Ø¬ÙˆØ¹</button>
            <h2 class="step-title">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ğŸ“±</h2>
            <p class="step-subtitle">Ø³ÙŠØ³Ø§Ø¹Ø¯Ù†Ø§ Ø¨Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ ÙÙŠ Ø­Ø§Ù„ Ø­ØµÙˆÙ„ Ù…Ø´ÙƒÙ„Ø©</p>
            
            <div class="error-message" id="error-step2"></div>
            
            <div class="input-group">
                <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                <div class="input-wrapper">
                    <span class="input-prefix">07</span>
                    <input 
                        type="tel" 
                        id="phone-input" 
                        class="with-prefix"
                        placeholder="XXXXXXXXX" 
                        maxlength="9"
                        pattern="[0-9]*"
                        inputmode="numeric"
                    >
                </div>
                <p class="input-hint">Ø£Ø¯Ø®Ù„ 9 Ø£Ø±Ù‚Ø§Ù… Ø¨Ø¹Ø¯ 07</p>
            </div>

            <button class="btn-primary" id="btn-phone-next" onclick="handlePhoneSubmit()">
                Ø§Ù„ØªØ§Ù„ÙŠ â†
            </button>
        </div>

        <!-- Step 3: Demographics -->
        <div class="step" id="step-3">
            <button class="btn-back" onclick="showStep(2)">â† Ø±Ø¬ÙˆØ¹</button>
            <h2 class="step-title">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© ğŸ“Š</h2>
            <p class="step-subtitle">Ø³Ø§Ø¹Ø¯Ù†Ø§ Ù†Ø¹Ø±ÙÙƒ Ø£ÙƒØ«Ø±!</p>
            
            <div class="error-message" id="error-step3"></div>
            
            <div class="input-group">
                <label>Ø§Ù„Ø¬Ù†Ø³</label>
                <div style="display: flex; gap: 12px;">
                    <button type="button" id="gender-male" class="gender-btn" onclick="selectGender('male')" style="flex: 1; padding: 14px; border: 2px solid #ddd; border-radius: 12px; background: white; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s;">
                        ğŸ‘¨ Ø°ÙƒØ±
                    </button>
                    <button type="button" id="gender-female" class="gender-btn" onclick="selectGender('female')" style="flex: 1; padding: 14px; border: 2px solid #ddd; border-radius: 12px; background: white; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s;">
                        ğŸ‘© Ø£Ù†Ø«Ù‰
                    </button>
                </div>
            </div>
            
            <div class="input-group">
                <label>Ø§Ù„Ø¹Ù…Ø±</label>
                <div class="input-wrapper">
                    <select id="age-input" style="width: 100%; padding: 14px; border: 2px solid #ddd; border-radius: 12px; font-size: 16px; background: white; cursor: pointer;">
                        <option value="">Ø§Ø®ØªØ± Ø¹Ù…Ø±Ùƒ</option>
                        <option value="12-15">12-15 Ø³Ù†Ø©</option>
                        <option value="16-18">16-18 Ø³Ù†Ø©</option>
                        <option value="19-22">19-22 Ø³Ù†Ø©</option>
                        <option value="23-30">23-30 Ø³Ù†Ø©</option>
                        <option value="31+">31+ Ø³Ù†Ø©</option>
                    </select>
                </div>
            </div>
            
            <div class="input-group">
                <label>Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</label>
                <div class="input-wrapper">
                    <select id="region-input" style="width: 100%; padding: 14px; border: 2px solid #ddd; border-radius: 12px; font-size: 16px; background: white; cursor: pointer;">
                        <option value="">Ø§Ø®ØªØ± Ù…Ø­Ø§ÙØ¸ØªÙƒ</option>
                        <option value="Ø¨ØºØ¯Ø§Ø¯">Ø¨ØºØ¯Ø§Ø¯</option>
                        <option value="Ø§Ù„Ø¨ØµØ±Ø©">Ø§Ù„Ø¨ØµØ±Ø©</option>
                        <option value="Ù†ÙŠÙ†ÙˆÙ‰">Ù†ÙŠÙ†ÙˆÙ‰</option>
                        <option value="Ø£Ø±Ø¨ÙŠÙ„">Ø£Ø±Ø¨ÙŠÙ„</option>
                        <option value="Ø§Ù„Ù†Ø¬Ù">Ø§Ù„Ù†Ø¬Ù</option>
                        <option value="ÙƒØ±Ø¨Ù„Ø§Ø¡">ÙƒØ±Ø¨Ù„Ø§Ø¡</option>
                        <option value="Ø°ÙŠ Ù‚Ø§Ø±">Ø°ÙŠ Ù‚Ø§Ø±</option>
                        <option value="Ø§Ù„Ø£Ù†Ø¨Ø§Ø±">Ø§Ù„Ø£Ù†Ø¨Ø§Ø±</option>
                        <option value="Ø¯ÙŠØ§Ù„Ù‰">Ø¯ÙŠØ§Ù„Ù‰</option>
                        <option value="ÙƒØ±ÙƒÙˆÙƒ">ÙƒØ±ÙƒÙˆÙƒ</option>
                        <option value="ØµÙ„Ø§Ø­ Ø§Ù„Ø¯ÙŠÙ†">ØµÙ„Ø§Ø­ Ø§Ù„Ø¯ÙŠÙ†</option>
                        <option value="Ø¨Ø§Ø¨Ù„">Ø¨Ø§Ø¨Ù„</option>
                        <option value="ÙˆØ§Ø³Ø·">ÙˆØ§Ø³Ø·</option>
                        <option value="Ù…ÙŠØ³Ø§Ù†">Ù…ÙŠØ³Ø§Ù†</option>
                        <option value="Ø§Ù„Ù…Ø«Ù†Ù‰">Ø§Ù„Ù…Ø«Ù†Ù‰</option>
                        <option value="Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ©">Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ©</option>
                        <option value="Ø¯Ù‡ÙˆÙƒ">Ø¯Ù‡ÙˆÙƒ</option>
                        <option value="Ø§Ù„Ø³Ù„ÙŠÙ…Ø§Ù†ÙŠØ©">Ø§Ù„Ø³Ù„ÙŠÙ…Ø§Ù†ÙŠØ©</option>
                        <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
                    </select>
                </div>
            </div>

            <button class="btn-primary" onclick="handleDemographicsSubmit()">
                Ø§Ù„ØªØ§Ù„ÙŠ â†
            </button>
        </div>

        <!-- Step 4: Full Name -->
        <div class="step" id="step-4">
            <button class="btn-back" onclick="showStep(3)">â† Ø±Ø¬ÙˆØ¹</button>
            <h2 class="step-title">Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„ âœï¸</h2>
            <p class="step-subtitle">ÙƒÙŠÙ ØªØ­Ø¨ Ø£Ù† Ù†Ù†Ø§Ø¯ÙŠÙƒØŸ</p>
            
            <div class="error-message" id="error-step4"></div>
            
            <div class="input-group">
                <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                <div class="input-wrapper">
                    <input 
                        type="text" 
                        id="name-input" 
                        placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯"
                        minlength="3"
                    >
                </div>
            </div>

            <button class="btn-primary" id="btn-finish" onclick="handleFinish()">
                Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ¹Ù„Ù… ğŸš€
            </button>
        </div>

        <!-- Step 5: Success -->
        <div class="step" id="step-success">
            <div class="success-icon">
                <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
            </div>
            <h2 class="step-title">ØªÙ… Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰</h2>
            <p class="step-subtitle">Ø¬Ø§Ø±ÙŠ ØªØ­ÙˆÙŠÙ„Ùƒ Ù„Ù„Ø¹Ø¨Ø©...</p>
        </div>

            </div>

    <!-- Supabase Config -->
    <script src="/js/supabase-config.js"></script>
    
    <script>
        // ====================================
        // INITIALIZATION
        // ====================================
        let supabaseClient;
        let currentUser = null;
        let userData = {
            authId: null,
            email: null,
            phone: null,
            fullName: null,
            picture: null
        };

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            supabaseClient = initSupabase();
            
            if (!supabaseClient) {
                showError('error-step1', 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…. Ø£Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.');
                return;
            }

            // Check URL params BEFORE cleaning
            const urlParams = new URLSearchParams(window.location.search);
            const fromIndex = urlParams.get('from') === 'index';
            const hasOAuthResponse = window.location.hash.includes('access_token');
            
            console.log('ğŸ”— URL state:', { fromIndex, hasOAuthResponse, hash: window.location.hash ? 'HAS_HASH' : 'NO_HASH' });
            
            // If we have OAuth tokens in URL, let Supabase process them first
            if (hasOAuthResponse) {
                console.log('ğŸ”„ Processing OAuth response...');
                // Fresh OAuth = clear any previous redirect counters
                sessionStorage.removeItem('loginRedirectCount');
                sessionStorage.removeItem('authRedirectAttempt');
                // Supabase will auto-process the hash, wait for it
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            // Now check for session (after OAuth processing)
            const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
            
            console.log('ğŸ” Session check:', { session: session ? 'EXISTS' : 'NONE', user: session?.user?.email, error: sessionError });
            
            // Clean URL AFTER session is established
            if (window.location.hash || window.location.search.includes('error=')) {
                const cleanUrl = window.location.origin + window.location.pathname;
                window.history.replaceState({}, document.title, cleanUrl);
                console.log('ğŸ§¹ Cleaned URL');
            }
            
            if (session) {
                currentUser = session.user;
                // Don't auto-redirect if coming from index (means profile incomplete)
                await checkUserRegistration(currentUser, !fromIndex);
            }

            // Listen for auth changes (for OAuth redirect)
            let alreadyChecked = session ? true : false; // Skip if already checked on load
            
            supabaseClient.auth.onAuthStateChange(async (event, session) => {
                console.log('ğŸ”” Auth event:', event, session?.user?.email);
                
                // Only process SIGNED_IN if we haven't already checked
                if (event === 'SIGNED_IN' && session && !alreadyChecked) {
                    alreadyChecked = true;
                    currentUser = session.user;
                    await checkUserRegistration(currentUser, true);
                }
            });

            // Input event listeners
            document.getElementById('phone-input').addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/\D/g, '');
            });

            document.getElementById('phone-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handlePhoneSubmit();
            });

            document.getElementById('name-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleFinish();
            });

            console.log('âœ… Login system ready');
        });

        // ====================================
        // CHECK USER REGISTRATION
        // ====================================
        async function checkUserRegistration(user, allowRedirect = true) {
            try {
                userData.authId = user.id;
                userData.email = user.email;
                
                // Extract name and picture from Google profile (user_metadata)
                const googleName = user.user_metadata?.full_name || user.user_metadata?.name || '';
                const googlePicture = user.user_metadata?.avatar_url || user.user_metadata?.picture || '';
                
                console.log('ğŸ” Checking user:', user.id);
                console.log('ğŸ“· Google profile:', { name: googleName, picture: googlePicture ? 'YES' : 'NO' });

                // Check if user exists in database
                const { data: existingUser, error } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('auth_id', user.id)
                    .maybeSingle();

                console.log('ğŸ“Š DB result:', { existingUser: existingUser ? 'EXISTS' : 'NEW', error });

                if (existingUser && existingUser.phone && existingUser.full_name) {
                    // Existing user with complete profile
                    sessionStorage.removeItem('authRedirectAttempt');
                    sessionStorage.setItem('loginRedirectCount', (sessionStorage.getItem('loginRedirectCount') ? parseInt(sessionStorage.getItem('loginRedirectCount')) + 1 : 1).toString());
                    console.log('âœ… Profile COMPLETE! Redirecting... (attempt ' + (sessionStorage.getItem('loginRedirectCount') ? parseInt(sessionStorage.getItem('loginRedirectCount')) + 1 : 1) + ')');
                    
                    // Try absolute path with trailing slash for Vercel
                    window.location.replace('/index');
                    return;
                } else if (existingUser) {
                    // User exists but incomplete profile
                    userData.phone = existingUser.phone;
                    userData.fullName = existingUser.full_name || googleName;
                    userData.picture = existingUser.avatar_url || googlePicture;
                    
                    if (!existingUser.phone) {
                        // Pre-fill name from Google if available
                        if (googleName) {
                            document.getElementById('name-input').value = googleName;
                        }
                        console.log('ğŸ“ Phone missing, showing step 2');
                        showStep(2);
                    } else if (!existingUser.full_name) {
                        // Use Google name automatically
                        if (googleName) {
                            userData.fullName = googleName;
                            // Skip to finish directly with Google name
                            await finishWithGoogleProfile(googleName, googlePicture);
                            return;
                        }
                        console.log('ğŸ“ Name missing, showing step 3');
                        showStep(3);
                    }
                } else {
                    // New user - create/update record with Google profile data
                    console.log('ğŸ‘¤ New user with Google profile:', googleName);
                    
                    userData.fullName = googleName;
                    userData.picture = googlePicture;
                    
                    // Pre-fill name input
                    if (googleName) {
                        document.getElementById('name-input').value = googleName;
                    }
                    
                    // Use upsert to handle existing email (different auth provider)
                    const { data: newUser, error: insertError } = await supabaseClient
                        .from('users')
                        .upsert({
                            auth_id: user.id,
                            email: user.email,
                            full_name: googleName || null,
                            avatar_url: googlePicture || null
                        }, {
                            onConflict: 'auth_id',
                            ignoreDuplicates: false
                        })
                        .select()
                        .single();
                    
                    if (insertError) {
                        console.error('Upsert error:', insertError);
                    } else {
                        console.log('âœ… User created:', newUser);
                    }
                    
                    // Show phone step (name is already filled from Google)
                    showStep(2);
                }
            } catch (error) {
                console.error('Check registration error:', error);
                showStep(2);
            }
        }

        // ====================================
        // STEP 1: GOOGLE SIGN IN
        // ====================================
        async function handleGoogleSignIn() {
            const btn = document.getElementById('btn-google');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...';

            try {
                // Use clean redirect URL (no query params or hash)
                const cleanRedirectUrl = window.location.origin + '/login';
                console.log('ğŸ”— Redirect URL:', cleanRedirectUrl);
                
                const { data, error } = await supabaseClient.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: cleanRedirectUrl
                    }
                });

                if (error) throw error;
                
                // OAuth will redirect, so we don't need to do anything else
                console.log('âœ… Redirecting to Google...');
                
            } catch (error) {
                console.error('Google Sign-in error:', error);
                showError('error-step1', 'ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ' + error.message);
                resetGoogleButton();
            }
        }

        function resetGoogleButton() {
            const btn = document.getElementById('btn-google');
            btn.disabled = false;
            btn.innerHTML = `
                <svg viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø­Ø³Ø§Ø¨ Google
            `;
        }

        // ====================================
        // STEP 2: PHONE NUMBER
        // ====================================
        function handlePhoneSubmit() {
            const phoneInput = document.getElementById('phone-input');
            const phone = phoneInput.value.trim();

            if (phone.length !== 9 || !/^[0-9]+$/.test(phone)) {
                showError('error-step2', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØµØ­ÙŠØ­ (9 Ø£Ø±Ù‚Ø§Ù…)');
                phoneInput.focus();
                return;
            }

            userData.phone = '07' + phone;
            showStep(3);
        }

        // ====================================
        // STEP 3: DEMOGRAPHICS
        // ====================================
        function selectGender(gender) {
            userData.gender = gender;
            const maleBtn = document.getElementById('gender-male');
            const femaleBtn = document.getElementById('gender-female');
            
            if (gender === 'male') {
                maleBtn.style.background = '#4CAF50';
                maleBtn.style.color = 'white';
                maleBtn.style.borderColor = '#4CAF50';
                femaleBtn.style.background = 'white';
                femaleBtn.style.color = '#333';
                femaleBtn.style.borderColor = '#ddd';
            } else {
                femaleBtn.style.background = '#E91E63';
                femaleBtn.style.color = 'white';
                femaleBtn.style.borderColor = '#E91E63';
                maleBtn.style.background = 'white';
                maleBtn.style.color = '#333';
                maleBtn.style.borderColor = '#ddd';
            }
        }
        
        function handleDemographicsSubmit() {
            const age = document.getElementById('age-input').value;
            const region = document.getElementById('region-input').value;
            
            if (!userData.gender) {
                showError('error-step3', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¬Ù†Ø³');
                return;
            }
            if (!age) {
                showError('error-step3', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…Ø±');
                return;
            }
            if (!region) {
                showError('error-step3', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©');
                return;
            }
            
            userData.age = age;
            userData.region = region;
            showStep(4);
            document.getElementById('name-input').focus();
        }

        // ====================================
        // STEP 4: FULL NAME & FINISH
        // ====================================
        async function handleFinish() {
            const nameInput = document.getElementById('name-input');
            const fullName = nameInput.value.trim();

            if (fullName.length < 3) {
                showError('error-step4', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„ (3 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)');
                nameInput.focus();
                return;
            }

            userData.fullName = fullName;

            const btn = document.getElementById('btn-finish');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';

            try {
                console.log('ğŸ’¾ Saving user data:', {
                    auth_id: userData.authId,
                    email: userData.email,
                    phone: userData.phone || 'NOT SET',
                    full_name: userData.fullName,
                    gender: userData.gender,
                    age: userData.age,
                    region: userData.region
                });
                
                // Save user to database with avatar and demographics
                const updateData = {
                    auth_id: userData.authId,
                    email: userData.email,
                    full_name: userData.fullName,
                    avatar_url: userData.picture || null,
                    last_login: new Date().toISOString()
                };
                
                // Only add phone if it exists
                if (userData.phone) {
                    updateData.phone = userData.phone;
                }
                
                // Only add demographics if they exist (to avoid column errors)
                if (userData.gender) {
                    updateData.gender = userData.gender;
                }
                if (userData.age) {
                    // Convert age range to number (take the lower bound) to match INTEGER column
                    const ageNumber = parseInt(userData.age.split('-')[0]);
                    updateData.age = ageNumber;
                }
                if (userData.region) {
                    updateData.region = userData.region;
                }
                
                // Add timeout protection
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Request timeout - please try again')), 10000)
                );
                
                const upsertPromise = supabaseClient
                    .from('users')
                    .upsert(updateData, {
                        onConflict: 'auth_id'
                    })
                    .select()
                    .single();
                
                const { data, error } = await Promise.race([upsertPromise, timeoutPromise]);

                if (error) {
                    console.error('âŒ Upsert error details:', error);
                    console.error('âŒ Error message:', error.message);
                    console.error('âŒ Error details:', error.details);
                    console.error('âŒ Error hint:', error.hint);
                    // If demographics columns don't exist, try saving without them
                    if (error.message && error.message.includes('column')) {
                        console.log('ğŸ”„ Column error - trying to save without demographics...');
                        const basicUpdateData = {
                            auth_id: userData.authId,
                            email: userData.email,
                            full_name: userData.fullName,
                            avatar_url: userData.picture || null,
                            last_login: new Date().toISOString()
                        };
                        if (userData.phone) {
                            basicUpdateData.phone = userData.phone;
                        }
                        
                        const { data: retryData, error: retryError } = await supabaseClient
                            .from('users')
                            .upsert(basicUpdateData, {
                                onConflict: 'auth_id'
                            })
                            .select()
                            .single();
                            
                        if (retryError) {
                            console.error('âŒ Retry also failed:', retryError);
                            throw retryError;
                        }
                        console.log('âœ… Saved without demographics:', retryData);
                    } else {
                        throw error;
                    }
                }

                console.log('âœ… User saved:', data);
                
                // Show success and redirect
                showStep('success');
                
                setTimeout(() => {
                    window.location.href = '/index';
                }, 1500);

            } catch (error) {
                console.error('Save user error:', error);
                showError('error-step3', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸: ' + (error.message || 'Unknown error'));
                btn.disabled = false;
                btn.textContent = 'Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ¹Ù„Ù… ğŸš€';
            }
        }

        // Auto-finish with Google profile (when name is already available)
        async function finishWithGoogleProfile(name, picture) {
            console.log('ğŸš€ Auto-finishing with Google profile:', name);
            
            try {
                const { data, error } = await supabaseClient
                    .from('users')
                    .upsert({
                        auth_id: userData.authId,
                        email: userData.email,
                        phone: userData.phone,
                        full_name: name,
                        avatar_url: picture || null,
                        last_login: new Date().toISOString()
                    }, {
                        onConflict: 'auth_id'
                    })
                    .select()
                    .single();

                if (error) throw error;

                console.log('âœ… Auto-saved with Google profile:', data);
                
                // Show success and redirect
                showStep('success');
                
                setTimeout(() => {
                    window.location.href = '/index';
                }, 1500);

            } catch (error) {
                console.error('Auto-finish error:', error);
                // Fall back to manual name entry
                showStep(3);
            }
        }

        // ====================================
        // UI HELPERS
        // ====================================
        function showStep(stepNumber) {
            // Hide all steps
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
            });

            // Show target step
            const targetStep = stepNumber === 'success' ? 'step-success' : `step-${stepNumber}`;
            document.getElementById(targetStep).classList.add('active');

            // Update dots
            document.querySelectorAll('.step-dot').forEach((dot, index) => {
                dot.classList.remove('active', 'completed');
                
                if (stepNumber === 'success') {
                    dot.classList.add('completed');
                } else if (index + 1 < stepNumber) {
                    dot.classList.add('completed');
                } else if (index + 1 === stepNumber) {
                    dot.classList.add('active');
                }
            });
        }

        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.classList.add('show');
            
            setTimeout(() => {
                errorElement.classList.remove('show');
            }, 4000);
        }
    </script>
</body>
</html>

